{
  "title": "Deploy nuxt.js static mit gitlab-ci",
  "date": "2019-09-27T18:31:42.478Z",
  "description": "In diesem Artikel zeige ich euch wie ihr eine Nuxt Application mit der Gitlab-CI bauen und auf dem Server ausrollen könne.",
  "author": "Markus Sommer",
  "image": "/img/deploy-nuxt-js-static-with-gitlab-ci.jpg",
  "thumbnail": "/img/deploy-nuxt-js-static-with-gitlab-ci-thumbnail.jpg",
  "bodyContent": "## Vorbereitung\n\n### Die App\n\nZuerst brauchen wir eine nuxt Applikation, die wir ausliefern möchten.\nDiese können wir relativ einfach über einen Terminal Befehl erstellen.\n\n```bash\nnpx create-nuxt-app my-website\n```\n\n### Das Repository\n\nUm den CI Prozess von Gitlab zu nutzen, reicht ein Kostenloser Account, in dem man ein Neues Repository anlegt oder ein bestehendes benutzt.\n\n![Alt Text](https://thepracticaldev.s3.amazonaws.com/i/3j0m2pr0yn2wf6x6qt8x.jpg)\n\nWie man ein neues Anlegt kann man auf der Seite https://docs.gitlab.com/ee/user/project/repository/#create-a-repository nachlesen\n\nNachdem man dies erledigt hat, muss man einen Private Key hinterlegen. Die CI braucht diesen um Daten via rsync ausliefern zu können.\n\nWie man ein Key Paar erstellt findet ihr hier. https://help.github.com/en/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent#generating-a-new-ssh-key\n\nIn meinem Fall wird die Variable SSH_PRIVATE_KEY genannt. Diese Bezeichnung brauchen wir später in unserer Konfiguration\n\n![Alt Text](https://thepracticaldev.s3.amazonaws.com/i/ix24yyppgtjru8gq3bj9.jpg)\n\nDen Public Key müsst ihr dann auf Euerem Server hinterlegen. **Wichtig** ist hier das der **Key** auch dem **Benutzer zugeordnet** wird der später auch von nginx benutzt wird, um die Seite auszuliefern. Meistens ist dies der www-data Benutzer.\n\n### Abschluss der Vorbereitung\n\nSo mehr müsst ich auch schon nicht machen denn ab jetzt kommt es nur noch auf die Konfiguration an.\n\n## Gitlab CI\n\nUm die Gitlab CI anzusprechen brauchen wir eine Datei im root unseres Projektes.\n\nDiese Datei trägt den Namen .gitlab-ci.yaml.\n\nSobald Gitlab diese Datei erkennt, wird der CI Runner Aktiv und führt die Darin enthaltenen Befehle aus.\n\n### Image\n\nDas Image, dass wir definieren wird für alle Befehle verwendet die nicht ein Explizites image besitzen. Wir verwenden des Node image da dies alles hat was wir zum Bauen unserer Applikation benötigen.\n\n```yaml\nimage: node\n```\n\n### Variablen\n\nHier Definieren wir weitere Variablen um sie nicht immer wieder eingeben zu müssen und unsere Datei auch in anderen Projekten verwenden zu können.\n\n```yaml\nvariables:\n    RSYNC: rsync -rtqx --links --safe-links --chmod=Du=rwx,Dgo=rx,Fu=rw,Fog=r --delete\n\n    PROD_URL: https://creativeworkspace.de/\n    PROD_USER: web_www\n    PROD_SERVER: 159.69.21.63\n    PROD_PATH: /var/www/clients/client1/web1/web\n    PROD_PORT: '22'\n```\n\n### Cache\n\nDamit gitlab zwischen den Stages die Daten nicht immer neu herunterladen muss und auch ein erneutes Ausführen schneller geht. Lassen wir gitlab den node_modules Ordner speichern. Dies spart uns sehr viel zeit, wenn wir mehrere Builds in kurzen abständen machen.\n\n```yaml\ncache:\n    paths:\n        - node_modules/\n```\n\n### Die Stages\n\nDamit wir eine Kontrolle haben welcher Prozess von Gitlab in welcher Reihenfolge ausgeführt wird erstellen wir 2 Stages.\nDiese Referenzieren wir in unseren Aufgaben die, die Gitlab CI Ausführen soll\n\n```yaml\nstages:\n    - build\n    - deploy\n```\n\n### Die Aufgaben\n\nDie erste Aufgabe die Gitlab für uns erledigen soll ist das Bauen der Application. Wir speichern uns danach den ordner _dist_ als Artefakt damit wir diesen dann im 2. Schritt deployen können.\n\n```yaml\nbuild:\n    stage: build\n    before_script:\n        - npm install\n    script:\n        - NODE_ENV=production npm run build\n        - NODE_ENV=production npm run generate\n    environment:\n        name: production\n    artifacts:\n        expire_in: 1 hour\n        name: '${CI_COMMIT_REF_NAME}'\n        paths:\n            - dist/\n```\n\nAls nächstes soll Gitlab für uns die Code Ausliefern.\nFür diesen Schritt benutze ich nun ein anderes Image das eine RSYNC Kompenente besitzt.\n\nHier passiert jetzt sehr viel auf einmal. Zuerst Fügen wir unseren generierten SSH Key zum Image hinzu. Anschließend führen wir einen RSYNC auf unseren Server aus. Somit haben wir dann den Inhalt des \\*_dist_ Ordners auf unserem server in dem Pfad den wir in den Variablen angegeben haben.\n\n```yaml\ndeploy:prod:\n    stage: deploy\n    image: 1drop/php-73-docker-utils\n    environment:\n        name: production\n        url: https://creativeworkspace.de\n    before_script:\n        - eval $(ssh-agent -s)\n        - echo \"$SSH_PRIVATE_KEY\" | tr -d '\\r' | ssh-add - > /dev/null\n        - mkdir -p ~/.ssh\n        - echo -e \"Host *\\n\\tStrictHostKeyChecking no\\n\\n\" > ~/.ssh/config\n        - cd dist/\n    script:\n        - $RSYNC -e \"ssh -p $PROD_PORT\" . $PROD_USER@$PROD_SERVER:$PROD_PATH\n    only:\n        - master\n```\n\n## Abschluss\n\nAb jetzt brauchen wir unserem nginx nur noch sagen, dass er die Daten aus diesem Verzeichnis ausliefern soll und fertig :)",
  "bodyHtml": "<h2>Vorbereitung</h2>\n<h3>Die App</h3>\n<p>Zuerst brauchen wir eine nuxt Applikation, die wir ausliefern möchten.\nDiese können wir relativ einfach über einen Terminal Befehl erstellen.</p>\n<pre><code class=\"hljs\">npx create-nuxt-app my-website</code></pre><h3>Das Repository</h3>\n<p>Um den CI Prozess von Gitlab zu nutzen, reicht ein Kostenloser Account, in dem man ein Neues Repository anlegt oder ein bestehendes benutzt.</p>\n<p><img src=\"https://thepracticaldev.s3.amazonaws.com/i/3j0m2pr0yn2wf6x6qt8x.jpg\" alt=\"Alt Text\"></p>\n<p>Wie man ein neues Anlegt kann man auf der Seite https://docs.gitlab.com/ee/user/project/repository/#create-a-repository nachlesen</p>\n<p>Nachdem man dies erledigt hat, muss man einen Private Key hinterlegen. Die CI braucht diesen um Daten via rsync ausliefern zu können.</p>\n<p>Wie man ein Key Paar erstellt findet ihr hier. https://help.github.com/en/articles/generating-a-new-ssh-key-and-adding-it-to-the-ssh-agent#generating-a-new-ssh-key</p>\n<p>In meinem Fall wird die Variable SSH_PRIVATE_KEY genannt. Diese Bezeichnung brauchen wir später in unserer Konfiguration</p>\n<p><img src=\"https://thepracticaldev.s3.amazonaws.com/i/ix24yyppgtjru8gq3bj9.jpg\" alt=\"Alt Text\"></p>\n<p>Den Public Key müsst ihr dann auf Euerem Server hinterlegen. <strong>Wichtig</strong> ist hier das der <strong>Key</strong> auch dem <strong>Benutzer zugeordnet</strong> wird der später auch von nginx benutzt wird, um die Seite auszuliefern. Meistens ist dies der www-data Benutzer.</p>\n<h3>Abschluss der Vorbereitung</h3>\n<p>So mehr müsst ich auch schon nicht machen denn ab jetzt kommt es nur noch auf die Konfiguration an.</p>\n<h2>Gitlab CI</h2>\n<p>Um die Gitlab CI anzusprechen brauchen wir eine Datei im root unseres Projektes.</p>\n<p>Diese Datei trägt den Namen .gitlab-ci.yaml.</p>\n<p>Sobald Gitlab diese Datei erkennt, wird der CI Runner Aktiv und führt die Darin enthaltenen Befehle aus.</p>\n<h3>Image</h3>\n<p>Das Image, dass wir definieren wird für alle Befehle verwendet die nicht ein Explizites image besitzen. Wir verwenden des Node image da dies alles hat was wir zum Bauen unserer Applikation benötigen.</p>\n<pre><code class=\"hljs\"><span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">node</span></code></pre><h3>Variablen</h3>\n<p>Hier Definieren wir weitere Variablen um sie nicht immer wieder eingeben zu müssen und unsere Datei auch in anderen Projekten verwenden zu können.</p>\n<pre><code class=\"hljs\"><span class=\"hljs-attr\">variables:</span>\n    <span class=\"hljs-attr\">RSYNC:</span> <span class=\"hljs-string\">rsync</span> <span class=\"hljs-string\">-rtqx</span> <span class=\"hljs-string\">--links</span> <span class=\"hljs-string\">--safe-links</span> <span class=\"hljs-string\">--chmod=Du=rwx,Dgo=rx,Fu=rw,Fog=r</span> <span class=\"hljs-string\">--delete</span>\n\n    <span class=\"hljs-attr\">PROD_URL:</span> <span class=\"hljs-string\">https://creativeworkspace.de/</span>\n    <span class=\"hljs-attr\">PROD_USER:</span> <span class=\"hljs-string\">web_www</span>\n    <span class=\"hljs-attr\">PROD_SERVER:</span> <span class=\"hljs-number\">159.69</span><span class=\"hljs-number\">.21</span><span class=\"hljs-number\">.63</span>\n    <span class=\"hljs-attr\">PROD_PATH:</span> <span class=\"hljs-string\">/var/www/clients/client1/web1/web</span>\n    <span class=\"hljs-attr\">PROD_PORT:</span> <span class=\"hljs-string\">'22'</span></code></pre><h3>Cache</h3>\n<p>Damit gitlab zwischen den Stages die Daten nicht immer neu herunterladen muss und auch ein erneutes Ausführen schneller geht. Lassen wir gitlab den node_modules Ordner speichern. Dies spart uns sehr viel zeit, wenn wir mehrere Builds in kurzen abständen machen.</p>\n<pre><code class=\"hljs\"><span class=\"hljs-attr\">cache:</span>\n    <span class=\"hljs-attr\">paths:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">node_modules/</span></code></pre><h3>Die Stages</h3>\n<p>Damit wir eine Kontrolle haben welcher Prozess von Gitlab in welcher Reihenfolge ausgeführt wird erstellen wir 2 Stages.\nDiese Referenzieren wir in unseren Aufgaben die, die Gitlab CI Ausführen soll</p>\n<pre><code class=\"hljs\"><span class=\"hljs-attr\">stages:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">build</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">deploy</span></code></pre><h3>Die Aufgaben</h3>\n<p>Die erste Aufgabe die Gitlab für uns erledigen soll ist das Bauen der Application. Wir speichern uns danach den ordner <em>dist</em> als Artefakt damit wir diesen dann im 2. Schritt deployen können.</p>\n<pre><code class=\"hljs\"><span class=\"hljs-attr\">build:</span>\n    <span class=\"hljs-attr\">stage:</span> <span class=\"hljs-string\">build</span>\n    <span class=\"hljs-attr\">before_script:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">install</span>\n    <span class=\"hljs-attr\">script:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">NODE_ENV=production</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">run</span> <span class=\"hljs-string\">build</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">NODE_ENV=production</span> <span class=\"hljs-string\">npm</span> <span class=\"hljs-string\">run</span> <span class=\"hljs-string\">generate</span>\n    <span class=\"hljs-attr\">environment:</span>\n        <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">production</span>\n    <span class=\"hljs-attr\">artifacts:</span>\n        <span class=\"hljs-attr\">expire_in:</span> <span class=\"hljs-number\">1</span> <span class=\"hljs-string\">hour</span>\n        <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">'${CI_COMMIT_REF_NAME}'</span>\n        <span class=\"hljs-attr\">paths:</span>\n            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">dist/</span></code></pre><p>Als nächstes soll Gitlab für uns die Code Ausliefern.\nFür diesen Schritt benutze ich nun ein anderes Image das eine RSYNC Kompenente besitzt.</p>\n<p>Hier passiert jetzt sehr viel auf einmal. Zuerst Fügen wir unseren generierten SSH Key zum Image hinzu. Anschließend führen wir einen RSYNC auf unseren Server aus. Somit haben wir dann den Inhalt des *<em>dist</em> Ordners auf unserem server in dem Pfad den wir in den Variablen angegeben haben.</p>\n<pre><code class=\"hljs\"><span class=\"hljs-attr\">deploy:prod:</span>\n    <span class=\"hljs-attr\">stage:</span> <span class=\"hljs-string\">deploy</span>\n    <span class=\"hljs-attr\">image:</span> <span class=\"hljs-string\">1drop/php-73-docker-utils</span>\n    <span class=\"hljs-attr\">environment:</span>\n        <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">production</span>\n        <span class=\"hljs-attr\">url:</span> <span class=\"hljs-string\">https://creativeworkspace.de</span>\n    <span class=\"hljs-attr\">before_script:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">eval</span> <span class=\"hljs-string\">$(ssh-agent</span> <span class=\"hljs-string\">-s)</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">\"$SSH_PRIVATE_KEY\"</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">tr</span> <span class=\"hljs-string\">-d</span> <span class=\"hljs-string\">'\\r'</span> <span class=\"hljs-string\">|</span> <span class=\"hljs-string\">ssh-add</span> <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">&gt;</span> <span class=\"hljs-string\">/dev/null</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">mkdir</span> <span class=\"hljs-string\">-p</span> <span class=\"hljs-string\">~/.ssh</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">echo</span> <span class=\"hljs-string\">-e</span> <span class=\"hljs-string\">\"Host *\\n\\tStrictHostKeyChecking no\\n\\n\"</span> <span class=\"hljs-string\">&gt;</span> <span class=\"hljs-string\">~/.ssh/config</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">cd</span> <span class=\"hljs-string\">dist/</span>\n    <span class=\"hljs-attr\">script:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">$RSYNC</span> <span class=\"hljs-string\">-e</span> <span class=\"hljs-string\">\"ssh -p $PROD_PORT\"</span> <span class=\"hljs-string\">.</span> <span class=\"hljs-string\">$PROD_USER@$PROD_SERVER:$PROD_PATH</span>\n    <span class=\"hljs-attr\">only:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">master</span></code></pre><h2>Abschluss</h2>\n<p>Ab jetzt brauchen wir unserem nginx nur noch sagen, dass er die Daten aus diesem Verzeichnis ausliefern soll und fertig :)</p>\n",
  "preview": "Vorbereitung\n\nDie App\n\nZuerst brauchen wir eine nuxt Applikation, die wir ausliefern möchten.\nDiese können wir",
  "dir": "content",
  "base": "2019-09-27-deploy-nuxt-js-static-mit-gitlab-ci.json",
  "ext": ".json",
  "sourceBase": "2019-09-27-deploy-nuxt-js-static-mit-gitlab-ci.md",
  "sourceExt": ".md"
}